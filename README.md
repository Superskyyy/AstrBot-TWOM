# TWOM Boss Timer Plugin for AstrBot

TWOM游戏Boss刷新计时器插件，支持自动提醒和双时区显示。

## ✨ 功能特性

- 🎯 **智能时间解析**：支持多种时间格式输入
- ⏰ **自动提醒**：Boss刷新前自动发送提醒消息
- 🌍 **双时区支持**：同时显示中国和加拿大时间（自动处理冬夏令时）
- 🏷️ **Boss别名系统**：支持多个别名，方便输入
- ➕ **手动添加计时器**：补充漏记的boss，支持指定刷新时间
- 📊 **多群管理**：支持群组白名单、群组过滤和核心群
- 💬 **私聊支持**：完全独立的私聊计时器，隐私保护
- 🗺️ **地图查询**：内置26张游戏地图，支持快速查询和查看
- 💾 **数据持久化**：使用JSON存储，重启后自动恢复
- ⚙️ **可配置**：通过WebUI灵活配置各项参数

## 📦 安装

1. 将插件文件复制到 AstrBot 的 `data/plugins/` 目录
2. 重启 AstrBot
3. 在 WebUI 中启用插件

## 🎮 使用方法

### 记录Boss死亡

格式：`<boss名> d [时间]`

**示例：**
```
wdk d              # 现在击杀
bmm d 23           # 当前小时的23分击杀
uk d 12:30         # 今天12:30击杀
darl d 12:30:45    # 今天12:30:45击杀
```

**输出示例：**
```
✅ 下一只 🐻‍❄️🐻‍❄️🐻‍❄️wdk：01月10日 15:23:45 | 🍁 01月10日 02:23:45
```

### 手动添加计时器

用于补充之前漏记的boss死亡时间，或者手动指定boss刷新时间。

格式：`/boss add <boss名> <刷新时间>`

**示例：**
```
/boss add wdk 15:30        # wdk将在今天15:30刷新
/boss add bmm 01-11 08:00  # bmm将在1月11日08:00刷新
/boss add uk 15:30:45      # uk将在今天15:30:45刷新
```

**支持的时间格式：**
- `HH:MM` 或 `HH:MM:SS` - 今天的某个时间
- `MM-DD HH:MM` 或 `MM-DD HH:MM:SS` - 指定日期的某个时间

**输出示例：**
```
✅ 已添加 🐻‍❄️🐻‍❄️🐻‍❄️wdk 的计时器
刷新时间：01月10日 15:30:00 | 🍁 01月10日 02:30:00

使用 /boss list 查看所有计时器
```

### 查看计时器列表

```
/boss list
bl
汇总
hz
```

**输出示例：**
```
⏳ Boss计时器列表：

🐻‍❄️🐻‍❄️🐻‍❄️wdk：01月10日 15:23:45 | 🍁 01月10日 02:23:45
🐍🐍🐍bmm：01月11日 08:00:00 | 🍁 01月10日 19:00:00
👿👿👿uk：01月11日 12:30:00 | 🍁 01月10日 23:30:00
```

### 取消计时器

```
/boss cancel wdk
/boss 取消 bmm
```

### 查看帮助

```
/boss help
/boss ?
/boss 帮助
```

### 地图查询

插件内置了26张游戏地图，方便快速查看副本路线。

**查看所有地图：**
```
/map list
/map 地图
```

**查看指定地图：**
```
/map 森林迷宫
/map 天空城东部
/map 灯塔1
/map 1           # 也可以使用地图ID
```

**支持的地图分类：**
- **伊斯洛**：实验室、神殿
- **天空城**：古代阁楼、堕落神殿、天空城东部/西部、未知迷宫、石塔要塞
- **森林迷宫**：森林、左洞、右洞
- **灯塔地牢**：1F-5F
- **莫勒波西兹**：庭院、根蔓、禁书库
- **西普奈尔之路**：石冠营地、石冠上坡路
- **其他**：悲叹祭坛、被污染的森林、赛勒殷祭坛、鲁纳夫等

使用 `/map list` 查看完整地图列表和别名。

## 🎯 支持的Boss

插件内置了 **71 个Boss**，涵盖所有主要区域。

### 主要Boss列表
| Boss名 | 别名 | 刷新时间 | Emoji |
|--------|------|---------|-------|
| bmm | bmm, 白发魔女 | 20小时57分 | 🐍🐍🐍 |
| uk | uk, ukpana | 20小时57分 | 👿👿👿 |
| wdk | wdk, wdk维护, 维德坎 | 2小时30分 | 🐻‍❄️🐻‍❄️🐻‍❄️ |
| darl | 女巫, darl | 48小时 | 🧙‍♀️🧙‍♀️🧙 |
| faith | faith | 5小时53分 | 👐👐👐 |
| bill | bill, bill-fake, billi | 7小时55分 | 🔮🔮🔮 |
| deer | deer, 鹿 | 24小时 | 🦌🦌🦌 |
| sl | sl | 24小时 | 🌳🌳🌳 |
| recluse | recluse, recluse-fake | 11小时23分 | 🦋🦋🦋 |
| dev | dev, dev维护 | 5小时33分 | 👢👢👢 |

### 其他Boss区域
- **练级区**：gpig, ypig, mush, butterfly (世界树小怪)
- **TZ系列**：tz, tzzz1-10 (各等级训练场)
- **天空区**：黑狗, steampunk, twist, tank, 红鸟, 泰坦, ft
- **沙漠区**：沙墓, 大眼, shack, suuk, svk, rb, ass
- **竞技场**：ak, blue, green, red
- **其他区域**：bm, lm, 7, 绿狐狸, d4, 花, 火狐, raven, 白鸟, 鬼蛇等

> 💡 使用 `/boss help` 查看完整的Boss别名列表

## ⚙️ 配置说明

在 AstrBot WebUI 中可以配置以下选项：

### 时区设置

- **主时区**：默认 `Asia/Shanghai`（中国时区）
- **第二时区**：默认 `America/Toronto`（加拿大东部时区）
  - 其他选项：`America/Vancouver`（西部）、`America/Edmonton`（山地）等
  - **自动处理冬夏令时**，无需手动调整！
- **显示第二时区**：是否显示加拿大时间

### 提醒设置

- **提醒时间点**：默认 `3`（分钟）
  - 表示在Boss刷新前3分钟发送提醒
  - 可自定义多个时间点，如 `30,15,3` 表示提前30分、15分、3分各提醒一次

### 群组管理

- **启用群组白名单**：开关，控制是否启用白名单功能
  - 关闭（默认）：所有群组都可以使用
  - 开启：只有白名单中的群组可以使用
- **白名单群组列表**：填写允许使用的群号
  - 例如：`["123456789", "987654321"]`
  - 只有这些群组能记录boss和收到提醒
- **白名单用户列表（私聊）**：填写允许私聊使用的用户QQ号
  - 例如：`["10001", "10002"]`
  - **留空则禁用私聊功能**
  - 只有这些用户可以在私聊中使用boss timer
  - 私聊计时器完全独立，不会出现在任何群里
- **核心群组**：设置为核心群的群号具有特殊权限
  - ✅ 可以用 `/boss list` 查看**所有群**的boss计时器
  - ✅ 只收到**自己群**记录的boss刷新提醒
  - ❌ **看不到**私聊的计时器（保护隐私）
  - 适合作为主Boss管理群，统一查看和管理
  - 例如：`["999888777"]` - 设置群999888777为核心群

### 自定义Boss

- **启用自定义Boss配置**：开启后可编辑 `data/boss_timer/bosses.json`
  - 可添加新Boss或修改现有Boss参数

## 📁 数据文件

插件数据和资源文件结构：

```
插件目录/
├── assets/                        # 资源文件（只读）
│   ├── maps.json                  # 地图配置
│   ├── IMO地图查看器_files/        # 地图图片（26张）
│   └── imo怪物图鉴.html            # 怪物图鉴HTML
│
data/boss_timer/                   # 数据目录
├── bosses.json                    # Boss配置（可自定义）
└── timers.json                    # 活跃的计时器（自动管理）
```

### 自定义Boss配置

编辑 `data/boss_timer/bosses.json`：

```json
{
  "custom_boss": {
    "display_name": "自定义Boss",
    "aliases": ["custom", "自定义"],
    "respawn_hours": 3,
    "respawn_minutes": 30,
    "respawn_seconds": 0,
    "emoji": "⭐"
  }
}
```

**参数说明：**
- `display_name`: 显示名称（实际显示为 emoji + display_name）
- `aliases`: 别名列表，触发时使用
- `respawn_hours`: 刷新小时数
- `respawn_minutes`: 刷新分钟数
- `respawn_seconds`: 刷新秒数
- `emoji`: 显示的emoji图标

## 🔧 技术细节

- **调度器**：使用 APScheduler 进行精确的时间调度
- **时区处理**：使用 Python `zoneinfo` 模块，自动处理夏令时转换
- **数据持久化**：JSON格式存储，易于备份和迁移
- **消息发送**：使用 AstrBot 的 `context.send_message()` API
- **群组支持**：兼容 QQ 群组消息格式

## 🚀 高级用法

### 群组隔离与核心群机制

**私聊（Private Chat）**：
- 完全独立的计时器，只有自己能看到
- 提醒通过私聊发送，不会出现在任何群里
- 核心群看不到私聊的计时器

**普通群（默认行为）**：
- 只能看到自己群记录的boss
- 只收到自己群记录的boss提醒
- 看不到其他群和私聊的计时器

**核心群（core_groups）**：
- 可以用 `/boss list` 查看所有群的boss计时器
- 只收到自己群记录的boss刷新提醒
- 看不到私聊的计时器（保护隐私）

**配置示例**：
```json
{
  "whitelist_enabled": true,
  "whitelist_groups": ["111111", "222222", "999999"],
  "core_groups": ["999999"]
}
```

### 多时区支持

不同地区的玩家可以使用不同的时区配置：
- 北美东部：`America/Toronto`
- 北美西部：`America/Vancouver`
- 欧洲：`Europe/London`
- 澳洲：`Australia/Sydney`

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！

## 📄 许可证

MIT License

## 🙏 致谢

基于原 NoneBot2 TWOM Bot 重构，感谢原作者的设计思路。
